{% from "macros/dialog.html" import dialog %}
{% set footer %}
  <button type="button" class="btn-ghost" onclick="this.closest('dialog').close()">{{ _('Cancel') }}</button>
  <button
    type="button"
    class="btn"
    :disabled="!envFile"
    @click="
      document.dispatchEvent(new CustomEvent('env-vars:insert', { detail: parseEnvFile(envFile) }));
      $el.closest('dialog').close();
    "
  >
    {{ _('Insert') }}
  </button>
{% endset %}
{% call dialog(
  id="dialog-env-paste",
  title=_("Paste .env file"),
  description=_("Paste the contents of your .env file here to add the variables to your environment variables list."),
  footer=footer,
  dialog_attrs={
    "class": "max-w-md",
    "x-data": "{ envFile: '' }"
  }
) %}
  <textarea
    class="textarea w-full font-mono min-h-24 py-[7px] break-all max-h-36 overflow-y-auto text-[13px]"
    x-model="envFile"
  ></textarea>
{% endcall %}
<script>
function parseEnvFile(content) {
  return content
    .split('\n')
    .filter(line => line.trim() && !line.startsWith('#'))
    .map(line => {
      const match = line.match(/^([^=]+)=(.*)$/);
      if (!match) return null;
      
      return {
        key: match[1].trim(),
        value: match[2].trim().replace(/^["']|["']$/g, '') // Remove quotes
      };
    })
    .filter(Boolean);
}
</script>

<div
  hx-get="{{ url_for('project_settings', team_slug=team.slug, project_name=project.name).include_query_params(fragment='env_vars') }}"
  hx-trigger="environments:updated from:window"
  hx-swap="outerHTML"
  hx-indicator="find .htmx-indicator"
>
  <form method="POST"
    action="{{ url_for('project_settings', team_slug=team.slug, project_name=project.name).include_query_params(fragment='env_vars') }}"
    hx-post="{{ url_for('project_settings', team_slug=team.slug, project_name=project.name).include_query_params(fragment='env_vars') }}"
    hx-indicator="next .htmx-indicator"
    hx-target="closest div"
    hx-swap="outerHTML"
    x-data="{ changed: false }"
    @input="changed = true"
    @change="changed = true"
    class="card"
  >
    {{ env_vars_form.csrf_token() }}
    <header class="border-b">
      <h2>{{ _('Environment variables') }}</h2>
      <p>{{ _('Variables available at build time and runtime. Changes will take effect after a new deployment.') }}</p>
    </header>

    <section class=" space-y-6">
      {% from "project/macros/env-vars.html" import render_env_vars %}
      {{ render_env_vars(env_vars_form, project.active_environments) }}
    </section>

    <footer class="flex justify-end gap-x-2">
      <button type="button" class="btn-sm-ghost"
        hx-get="{{ url_for('project_settings', team_slug=team.slug, project_name=project.name).include_query_params(fragment='env_vars') }}"
        hx-target="closest form" hx-swap="outerHTML" :disabled="!changed">{{ _('Cancel') }}</button>
      <button class="btn-sm" :disabled="!changed">{{ _('Save') }}</button>
    </footer>
  </form>

  <div class="htmx-indicator flex items-center justify-center inset-0 absolute bg-background/80 rounded-xl">
    <div class="flex items-center gap-x-2 text-muted-foreground [&>svg]:size-4 [&>svg]:animate-spin">
      {% include "icons/loader.svg" %}
      {{ _('Saving') }}
    </div>
  </div>
</div>