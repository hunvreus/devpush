{% from "macros/dialog.html" import dialog %}

<div class="card" id="deploy-tokens-section">
  <header class="border-b">
    <h2>{{ _('Deploy Tokens') }}</h2>
    <p>{{ _('Create tokens to trigger deployments via API.') }}</p>
  </header>

  <section class="space-y-6">
    {% if deploy_tokens %}
      <div class="rounded-xl border relative overflow-x-auto scrollbar">
        <table class="table">
          <thead>
            <tr>
              <th>{{ _('Name') }}</th>
              <th>{{ _('Environment') }}</th>
              <th>{{ _('Last Used') }}</th>
              <th>{{ _('Created') }}</th>
              <th>{{ _('Status') }}</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for token in deploy_tokens %}
              <tr>
                <td class="font-medium">{{ token.name }}</td>
                <td>
                  {% if token.environment_id %}
                    {% set env = project.get_environment_by_id(token.environment_id) %}
                    {% if env %}
                      <span class="badge" style="background-color: {{ env.color }}20; color: {{ env.color }};">{{ env.name }}</span>
                    {% else %}
                      <span class="text-sm text-muted-foreground">{{ token.environment_id }}</span>
                    {% endif %}
                  {% else %}
                    <span class="text-sm text-muted-foreground">{{ _('All environments') }}</span>
                  {% endif %}
                </td>
                <td>
                  {% if token.last_used_at %}
                    <span class="text-sm text-muted-foreground">{{ token.last_used_at.strftime('%b %d, %Y %H:%M') }}</span>
                  {% else %}
                    <span class="text-sm text-muted-foreground">{{ _('Never') }}</span>
                  {% endif %}
                </td>
                <td>
                  <span class="text-sm text-muted-foreground">{{ token.created_at.strftime('%b %d, %Y') }}</span>
                </td>
                <td>
                  {% if token.status == 'active' %}
                    <span class="badge badge-success">{{ _('Active') }}</span>
                  {% else %}
                    <span class="badge badge-muted">{{ _('Revoked') }}</span>
                  {% endif %}
                </td>
                <td class="w-full text-right">
                  {% set delete_trigger %}
                    {% include "icons/trash-2.svg" %}
                  {% endset %}
                  {% call dialog(
                    id="revoke-token-" ~ token.id,
                    trigger=delete_trigger,
                    title=_('Revoke Token "%(name)s"?', name=token.name),
                    trigger_attrs={
                      "class": "btn-icon-ghost text-destructive hover:bg-destructive/10 dark:hover:bg-destructive/20",
                      "aria-label": _('Revoke'),
                      "data-tooltip": _('Revoke'),
                      "data-align": "end",
                    },
                    dialog_attrs={"class": "max-w-md whitespace-normal text-left"},
                    close_button=false,
                    close_on_overlay_click=false
                  ) %}
                    <div class="space-y-4">
                      <p>{{ _("This will permanently revoke the token. Any systems using this token will no longer be able to trigger deployments.") }}</p>
                      <p>{{ _('To confirm, enter the token name <b>"%(name)s"</b> below.', name=token.name) | safe }}</p>
                      <form
                        method="post"
                        action="{{ url_for('project_settings', team_slug=team.slug, project_name=project.name).include_query_params(fragment='delete_token') }}"
                        hx-post="{{ url_for('project_settings', team_slug=team.slug, project_name=project.name).include_query_params(fragment='delete_token') }}"
                        hx-swap="outerHTML"
                        hx-target="#deploy-tokens-section"
                        hx-indicator="find .htmx-indicator"
                        hx-disabled-elt="input, button"
                        x-data="{ isValid: false }"
                        @submit.prevent="isValid && $el.requestSubmit()"
                        @keydown.enter.prevent="if(isValid){ $el.closest('form').requestSubmit() }"
                      >
                        {{ delete_token_form.csrf_token }}
                        <input type="hidden" name="token_id" value="{{ token.id }}" />
                        <div class="grid gap-y-2">
                          {{ delete_token_form.confirm(
                            class_="w-full input",
                            placeholder=_("Type the token name to confirm"),
                            ** {"@input": "isValid = $event.target.value === '" ~ token.name ~ "'"}
                          ) }}
                        </div>
                        <footer class="flex justify-end gap-x-2 pt-4">
                          <button type="button" class="btn-ghost" onclick="this.closest('dialog').close()">{{ _('Cancel') }}</button>
                          <button type="submit" class="btn-destructive" :disabled="!isValid">{{ _('Revoke') }}</button>
                        </footer>
                      </form>
                    </div>
                  {% endcall %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-center py-8 text-muted-foreground">
        <p>{{ _('No deploy tokens created yet.') }}</p>
      </div>
    {% endif %}

    {# Show newly created token #}
    {% if new_token_value %}
      <div class="bg-success/10 border border-success/20 rounded-lg p-4 space-y-2">
        <p class="font-medium text-success">{{ _('Token created successfully!') }}</p>
        <p class="text-sm text-muted-foreground">{{ _('Copy this token now. You won\'t be able to see it again.') }}</p>
        <div class="flex items-center gap-x-2">
          <code class="flex-1 bg-muted px-3 py-2 rounded font-mono text-sm break-all">{{ new_token_value }}</code>
          <button 
            type="button" 
            class="btn-icon-ghost shrink-0"
            onclick="navigator.clipboard.writeText('{{ new_token_value }}'); this.innerHTML = '{% include "icons/check.svg" %}'; setTimeout(() => this.innerHTML = '{% include "icons/copy.svg" %}', 2000)"
            data-tooltip="{{ _('Copy') }}"
          >
            {% include "icons/copy.svg" %}
          </button>
        </div>
      </div>
    {% endif %}

    <div class="space-y-4">
      <h3 class="font-medium">{{ _('Create a new token') }}</h3>

      <form
        class="space-y-4"
        method="post"
        action="{{ url_for('project_settings', team_slug=team.slug, project_name=project.name).include_query_params(fragment='add_token') }}"
        hx-post="{{ url_for('project_settings', team_slug=team.slug, project_name=project.name).include_query_params(fragment='add_token') }}"
        hx-swap="outerHTML"
        hx-target="#deploy-tokens-section"
        hx-indicator="find .htmx-indicator"
        hx-disabled-elt="input, button, select"
        x-data="{ name: '' }"
      >
        {{ token_form.csrf_token }}

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="grid gap-y-2">
            {{ token_form.name.label(class="label") }}
            {{ token_form.name(class="input", placeholder=_("e.g., CI/CD Pipeline"), **{"x-model": "name"}) }}
            {% for error in token_form.name.errors %}
              <p class="text-destructive text-sm">{{ error }}</p>
            {% endfor %}
          </div>

          <div class="grid gap-y-2">
            {{ token_form.environment_id.label(class="label") }}
            {{ token_form.environment_id(class="select w-full") }}
            <p class="text-sm text-muted-foreground">{{ _('Limit which environments this token can deploy to.') }}</p>
          </div>
        </div>

        <div class="flex justify-end">
          <button type="submit" class="btn" :disabled="!name">
            {% include "icons/plus.svg" %}
            {{ _('Create Token') }}
          </button>
        </div>
      </form>
    </div>

    {# API documentation #}
    <details class="border rounded-xl p-4">
      <summary class="cursor-pointer font-medium">{{ _('API Usage') }}</summary>
      <div class="mt-4 space-y-4">
        <div>
          <h4 class="font-medium text-sm mb-2">{{ _('Trigger a Deployment') }}</h4>
          <pre class="text-xs bg-muted p-3 rounded-lg overflow-x-auto"><code>curl -X POST {{ request.url.scheme }}://{{ request.url.netloc }}/api/deploy \
  -H "Authorization: Bearer dp_your_token_here" \
  -H "Content-Type: application/json" \
  -d '{
    "branch": "main",
    "environment_id": "prod"
  }'</code></pre>
        </div>
        <div>
          <h4 class="font-medium text-sm mb-2">{{ _('Check Deployment Status') }}</h4>
          <pre class="text-xs bg-muted p-3 rounded-lg overflow-x-auto"><code>curl {{ request.url.scheme }}://{{ request.url.netloc }}/api/deployments/{deployment_id} \
  -H "Authorization: Bearer dp_your_token_here"</code></pre>
        </div>
        <div>
          <h4 class="font-medium text-sm mb-2">{{ _('Request Body (Optional)') }}</h4>
          <ul class="text-sm text-muted-foreground space-y-1">
            <li><code class="font-mono bg-muted px-1 rounded">branch</code>: {{ _('Branch to deploy (defaults to environment\'s configured branch)') }}</li>
            <li><code class="font-mono bg-muted px-1 rounded">environment_id</code>: {{ _('Environment to deploy to (defaults to token\'s environment or "prod")') }}</li>
            <li><code class="font-mono bg-muted px-1 rounded">commit_sha</code>: {{ _('Specific commit to deploy (defaults to latest on branch)') }}</li>
          </ul>
        </div>
        <div>
          <h4 class="font-medium text-sm mb-2">{{ _('Response') }}</h4>
          <pre class="text-xs bg-muted p-3 rounded-lg overflow-x-auto"><code>{
  "message": "Deployment queued",
  "deployment": {
    "id": "abc123...",
    "project_id": "{{ project.id }}",
    "project_name": "{{ project.name }}",
    "environment_id": "prod",
    "environment_name": "Production",
    "branch": "main",
    "commit_sha": "...",
    "status": "queued",
    "url": "/api/deployments/abc123..."
  }
}</code></pre>
        </div>
      </div>
    </details>
  </section>

  <div class="htmx-indicator flex items-center justify-center inset-0 absolute bg-background/80 rounded-xl">
    <div class="flex items-center gap-x-2 text-muted-foreground [&>svg]:size-4 [&>svg]:animate-spin">
      {% include "icons/loader.svg" %}
      {{ _("Saving") }}
    </div>
  </div>
</div>
