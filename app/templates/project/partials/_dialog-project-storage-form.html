{% from "macros/select.html" import select %}
{% from "project/macros/environment-label.html" import environment_label %}

<form
  method="post"
  action="{{ url_for('project_storage', team_slug=team.slug, project_name=project.name).include_query_params(fragment=fragment) }}"
  hx-post="{{ url_for('project_storage', team_slug=team.slug, project_name=project.name).include_query_params(fragment=fragment) }}"
  hx-swap="outerHTML"
  class="space-y-6"
>
  {{ form.csrf_token }}
  <div class="space-y-3 flex-1">
    {% if fragment == 'create_storage' %}
      {{ form.name.label(class_="label") }}
      {{ form.name(class_="input", placeholder=_("Storage name")) }}
      {% for error in form.name.errors %}
        <p class="text-destructive text-sm">{{ error }}</p>
      {% endfor %}
    {% else %}
      {{ form.storage_id.label(class_="label") }}
      <input type="hidden" name="project_id" value="{{ project.id }}">
      {{ form.association_id }}
      {% if storages %}
        {% set items=[] %}
        {% for storage in storages %}
          {% set items = items.append({
            "label": storage.name,
            "value": storage.id
          }) %}
        {% endfor %}
        {{ select(
          name="storage_id",
          selected=form.storage_id.data,
          is_combobox=true,
          items=items,
          main_attrs={"class": "w-full"},
          trigger_attrs={
            "aria-invalid": "true" if form.storage_id.errors else "",
            "class": "w-full truncate"
          }
        ) }}
        {% for error in form.storage_id.errors %}
          <p class="text-destructive text-sm">{{ error }}</p>
        {% endfor %}
      {% else %}
        <p class="text-muted-foreground text-sm">{{ _('No available storage.') }}</p>
      {% endif %}
    {% endif %}
  </div>

  <div class="space-y-3">
    {{ form.environment_ids.label(class_="label") }}
    {% set items=[] %}
    
    {% for environment in project.active_environments %}
      {% set label %}
        {{ environment_label(environment) }}
      {% endset %}
      {% set items = items.append({
        "label": label,
        "value": environment.id
      }) %}
    {% endfor %}
    {{ select(
      name="environment_ids",
      selected=form.environment_ids.data,
      is_combobox=true,
      multiple=true,
      placeholder=_("All environments"),
      items=items,
      main_attrs={"class": "w-full"},
      trigger_attrs={
        "aria-invalid": "true" if form.environment_ids.errors else "",
        "class": "w-full truncate"
      }
    ) }}
    {% for error in form.environment_ids.errors %}
      <p class="text-destructive text-sm">{{ error }}</p>
    {% endfor %}
  </div>

  <footer class="flex justify-end gap-x-2">
    <button type="button" class="btn-ghost" onclick="this.closest('dialog').close()">{{ _('Cancel') }}</button>
    <button type="submit" class="btn">
      {{ _('Create and connect') if fragment == 'create_storage' else _('Connect') }}
    </button>
  </footer>
</form>
