{% macro render_env_vars(form, environments, storages) %}
{% from "macros/select.html" import select %}
{% from "macros/icon-avatar.html" import icon_avatar %}
{% from "macros/dropdown-menu.html" import dropdown_menu %}
{% from "project/macros/environment-label.html" import environment_label %}
{% from "macros/dialog.html" import dialog %}
{% set footer %}
  <button type="button" class="btn-ghost" onclick="this.closest('dialog').close()">{{ _('Cancel') }}</button>
  <button
    type="button"
    class="btn"
    :disabled="!envFile"
    @click="
      const envVars = envFile.split('\n')
        .filter(line => line.trim() && !line.startsWith('#'))
        .map(line => {
          const match = line.match(/^([^=]+)=(.*)$/);
          if (!match) return null;
          
          return {
            key: match[1].trim(),
            value: match[2].trim().replace(/^[\x22\x27]|[\x22\x27]$/g, '')
          };
        })
        .filter(Boolean);
      document.dispatchEvent(new CustomEvent('env-vars:insert', { detail: envVars }));
      envFile = '';
      $el.closest('dialog').close();
    "
  >
    {{ _('Insert') }}
  </button>
{% endset %}
{% call dialog(
  id="dialog-env-paste",
  title=_("Paste .env file"),
  description=_("Paste the contents of your .env file here to add the variables to your environment variables list."),
  footer=footer,
  dialog_attrs={
    "class": "max-w-md",
    "x-data": "{ envFile: '' }"
  }
) %}
  <textarea
    class="textarea w-full font-mono min-h-24 py-[7px] break-all max-h-36 overflow-y-auto text-[13px]"
    x-model="envFile"
  ></textarea>
{% endcall %}

<div
  class="space-y-2"
  x-data="{
    newEnvVars: [],
    envVarsLength: {{ form.env_vars | length }}
  }"
  x-init="if (envVarsLength === 0) newEnvVars.push({ key: '', value: '' })"
>
  <div class="flex gap-x-2 border-b border-border/50 pb-2">
    <div class="w-full label">{{ _('Key') }}</div>
    <div class="w-full label">{{ _('Value') }}</div>
    <div class="w-full label">{{ _('Environment') }}</div>
    <div class="shrink-0 w-9"></div>
  </div>
  {% for env_var in form.env_vars %}
    <div class="flex gap-x-2 items-start" x-data="{ remove: false }">
      <div class="flex-1 space-y-2">
        {{ env_var.key(
          id=False,
          class="input w-full font-mono text-[13px]",
          placeholder="e.g. MY_VAR",
          pattern="[A-Za-z_][A-Za-z0-9_]*",
          **{
            "aria-invalid": "true" if env_var.key.errors,
            ":disabled": "remove"
          }
        ) }}
        {% for error in env_var.key.errors %}
          <p class="text-sm text-destructive">{{ error }}</p>
        {% endfor %}
      </div>
      <div
        class="flex-1 space-y-2"
        x-data="{ secret: true }"
      > 
        <input
          type="password"
          value="**********"
          class="font-mono text-[13px] mb-0"
          @focus="
            secret = false;
            $nextTick(() => {
              if ($el.nextElementSibling?.tagName === 'TEXTAREA') {
                $el.nextElementSibling.focus();
              }
            })
          "
          :disabled="remove"
          :hidden="!secret"
        >
        {{ env_var.value(
          id=False,
          class="textarea w-full font-mono text-[13px] min-h-9 py-[7px] break-all",
          pattern="[A-Za-z_][A-Za-z0-9_]*",
          **{
            "aria-invalid": "true" if env_var.value.errors,
            ":disabled": "remove",
            "@focusout": "secret = true",
            ":hidden": "secret"
          }
        ) }}
        {% for error in env_var.value.errors %}
          <p class="text-sm text-destructive">{{ error }}</p>
        {% endfor %}
      </div>
      <div class="flex-1 space-y-2 min-w-0">
        {% set items = [{"label": _('All environments'), "value": ""}] %}
        {% for environment in environments %}
          {% set _ = items.append({"label": environment_label(environment), "value": environment.slug}) %}
        {% endfor %}
        {{ select(
          name='env_vars-' ~ loop.index0 ~ '-environment',
          selected=env_var.environment.data,
          items=items,
          main_attrs={"class": "w-full"},
          trigger_attrs={
            "class": "w-full",
            ":disabled": "remove"
          }
        ) }}
        {% for error in env_var.environment.errors %}
          <p class="text-sm text-destructive">{{ error }}</p>
        {% endfor %}
      </div>
      <div class="shrink-0">
        {{ env_var.delete(
          class="hidden",
          **{'x-model': 'remove'}
        ) }}
        <button
          type="button"
          class="btn-icon-ghost"
          :class="{ 'text-destructive hover:bg-destructive/10 dark:hover:bg-destructive/20': !remove }"
          @click="remove = !remove; $dispatch('change');"
          :aria-label="!remove ? 'Remove' : 'Undo'"
          :data-tooltip="!remove ? 'Remove' : 'Undo'"
        >
          <span x-show="!remove" class="text-destructive">{% include "icons/trash-2.svg" %}</span>
          <span x-show="remove">{% include "icons/undo-2.svg" %}</span>
        </button>
      </div>
    </div>
  {% endfor %}
  <template x-for="(item, index) in newEnvVars" :key="index">
    <div class="flex gap-x-2 items-start" x-data="{
        actualIndex: envVarsLength + index,
        remove: false
      }">
      <div class="flex-1">
        <input
          type="text"
          :name="'env_vars-' + actualIndex + '-key'"
          :disabled="remove"
          class="input w-full font-mono text-[13px]"
          placeholder="e.g. MY_VAR"
          pattern="[A-Za-z_][A-Za-z0-9_]*"
          :value="item.key"
        />
      </div>
      <div class="flex-1">
        <textarea
          :name="'env_vars-' + actualIndex + '-value'"
          :disabled="remove"
          class="textarea w-full font-mono text-[13px] min-h-9 py-[7px] break-all"
          pattern="[A-Za-z_][A-Za-z0-9_]*"
          :value="item.value"
        ></textarea>
      </div>
      <div class="field flex-1 min-w-0">
        {% set items = [{"label": _('All environments'), "value": ""}] %}
        {% for environment in environments %}
          {% set _ = items.append({"label": environment_label(environment), "value": environment.slug}) %}
        {% endfor %}
        {{ select(
          name="",
          items=items,
          main_attrs={"class": "w-full"},
          trigger_attrs={
            "class": "w-full",
            ":disabled": "remove"
          },
          input_attrs={
            ":name": "'env_vars-' + actualIndex + '-environment'",
            ":disabled": "remove"
          }
        ) }}
      </div>
      <div class="shrink-0">
        <input type="checkbox" x-model="remove" class="hidden">
        <button
          class="btn-icon-ghost"
          type="button"
          :class="{ 'text-destructive hover:bg-destructive/10 dark:hover:bg-destructive/20': !remove }"
          @click="remove = !remove; $dispatch('change');"
          aria-label="Remove"
          data-tooltip="Remove"
        >
          <span x-show="!remove">{% include "icons/trash-2.svg" %}</span>
          <span x-show="remove">{% include "icons/undo-2.svg" %}</span>
        </button>
      </div>
    </div>
  </template>
  <div class="flex gap-x-2">
    <div role="group" class="button-group">
      <button type="button" class="btn-sm-outline" @click="newEnvVars.push({ key: '', value: '' })">
        {% include "icons/plus.svg" %}
        {{ _('Add variable') }}
      </button>
      {% if storages %}
        {% set trigger %}
          {% include "icons/chevron-down.svg" %}
        {% endset %}
        {% call dropdown_menu(
          trigger=trigger,
          trigger_attrs={"class": "btn-sm-icon-outline"},
        ) %}
          {% for storage in storages %}
            {% if storage.type == "database" %}
              {% set storage_path = "/data/database/" ~ storage.name ~ "/db.sqlite" %}
              {% set key = 'DB_PATH' %}
            {% else %}
              {% set storage_path = "/data/volume/" ~ storage.name %}
              {% set key = 'VOLUME_PATH' %}
            {% endif %}
            <div
              role="menuitem"
              @click="newEnvVars.push({ key: '{{ key }}', value: '{{ storage_path }}' })"
            >
              {{ icon_avatar(type=storage.type, size="xs") }}
              <span class="truncate">{{ storage.name }}</span>
            </div>
          {% endfor %}
        {% endcall %}
      {% endif %}
    </div>
    <button
      type="button"
      class="btn-sm-icon-outline"
      @click="document.getElementById('dialog-env-paste').showModal()"
      @env-vars:insert.document="
        if (!event.detail) return;
        for (const envVar of event.detail) {
          newEnvVars.push({
            key: envVar.key,
            value: envVar.value,
            environment: ''
          });
        }
        if (newEnvVars.length > 0) {
          // We remove all of the empty rows
          for (let i = 0; i < newEnvVars.length; i++) {
            if (newEnvVars[i].key === '' && newEnvVars[i].value === '') {
              newEnvVars.splice(i, 1);
            }
          }
        }
        $el.closest('form').dispatchEvent(new Event('change'));
      "
      data-tooltip="{{ _('Paste .env file') }}"
      aria-label="{{ _('Paste .env file') }}"
    >
      {% include "icons/file-text.svg" %}
    </button>
  </div>
</div>
{% endmacro %}