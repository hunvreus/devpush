{% extends "layouts/app.html" %}

{% block app_content %}
{% from "macros/avatar.html" import avatar with context %}
{% from "project/macros/environment-label.html" import environment_label %}
{% from "macros/tabs.html" import tabs %}
{% from "macros/icon-avatar.html" import icon_avatar %}
{% from "macros/dropdown-menu.html" import dropdown_menu %}
{% from "macros/dialog.html" import dialog %}
{% from "macros/select.html" import select %}
{% from "macros/popover.html" import popover %}
{% from "macros/copy.html" import copy %}

{% set storage_types = {
  "database": _("Database"),
  "volume": _("Volume"),
  "kv": _("KV"),
  "queue": _("Queue")
} %}

{% include "project/partials/_dialog-project-storage.html" %}

<div class="container max-w-screen-xl mx-auto p-8 space-y-6">
  <header class="flex justify-between items-center">
    <h1 class="h1 flex items-center gap-x-3">
      <a href="{{ rel_url_for('project_index', team_slug=team.slug, project_name=project.name) }}" class="shrink-0">
        {{ avatar(item=project, prefix="project", name=project.name, size="md") }}
      </a>
      <span class="text-muted-foreground/25 font-normal">/</span>
      {{ _("Storage") }}
    </h1>

    {% if associations %}
      <button
        type="button"
        class="btn"
        onclick="document.getElementById('dialog-project-storage').showModal()"
      >
      {% include "icons/plus.svg" %}
        {{ _("Add storage") }}
      </button>
    {% endif %}
  </header>

  {% if associations %}
    <section class="space-y-4">
      <ul>
        {% for association in associations %}
          <li class="flex gap-x-6 items-center border border-b-0 last:border-b first:rounded-t-xl last:rounded-b-xl px-4 h-12 text-sm hover:bg-muted/50 transition-colors min-w-0">
            <a
              href="{{ rel_url_for('team_storage_item', team_slug=team.slug, storage_name=association.storage.name) }}"
              class="flex items-center gap-x-2 font-medium [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-muted-foreground"
              data-tooltip="{{ _('%(type)s name', type=storage_types[association.storage.type]) }}"
              aria-label="{{ _('%(type)s name', type=storage_types[association.storage.type]) }}"
              hx-boost="true"
            >
              {{ icon_avatar(type=association.storage.type, size="xs") }}
              <span class="truncate max-w-3xs">{{ association.storage.name }}</span>
            </a>

            <div
              class="text-muted-foreground"
              data-tooltip="{{ _('Environments') }}"
              aria-label="{{ _('Environments') }}"
            >
              {% if association.environment_ids %}
                {% for env_id in association.environment_ids %}
                  {% set env = project.get_environment_by_id(env_id) %}
                  {{ env.name }}{% if not loop.last %}, {% endif %}
                {% endfor %}
              {% else %}
                {{ _('All environments') }}
              {% endif %}
            </div>

            {% set storage = association.storage %}
            {% include "project/partials/_storage-status.html" %}

            <div class="flex items-center ml-auto">
              {% if storage.type == "volume" %}
                {{ copy(
                  value="/data/volume/" ~ storage.name,
                  attrs={"tooltip": _('Copy volume path')},
                  class="btn-sm-icon-ghost"
                ) }}
              {% else %}
                {{ copy(
                  value="/data/database/" ~ storage.name ~ "/db.sqlite",
                  attrs={"tooltip": _('Copy database path')},
                  class="btn-sm-icon-ghost"
                ) }}
              {% endif %}

              {% if get_access(role, "admin") or association.storage.created_by_user_id == current_user.id %}
                {% set icon_unplug %}{% include "icons/unplug.svg" %}{% endset %}
                {% set icon_edit %}{% include "icons/pencil.svg" %}{% endset %}
                {% set icon_settings %}{% include "icons/settings.svg" %}{% endset %}
                {% set trigger %}
                  {% include "icons/ellipsis.svg" %}
                {% endset %}
                {% call dropdown_menu(
                  trigger=trigger,
                  trigger_attrs={"class": "btn-sm-icon-ghost [&>svg]:shrink-0"},
                  popover_attrs={"data-align": "end"},
                  items=[
                    {
                      "icon": icon_edit,
                      "label": _("Environments"),
                      "attrs": {
                        "onclick": "document.getElementById('dialog-storage-environments-" ~ association.id ~ "').showModal()"
                      },
                    },
                    {
                      "icon": icon_settings,
                      "label": _("Settings"),
                      "url": rel_url_for('team_storage_item', team_slug=team.slug, storage_name=association.storage.name),
                    },
                    {"type": "separator"},
                    {
                      "icon": icon_unplug,
                      "label": _("Disconnect"),
                      "attrs": {
                        "class": "text-destructive hover:bg-destructive/10 dark:hover:bg-destructive/20 focus:bg-destructive/10 dark:focus:bg-destructive/20 focus:text-destructive [&_svg]:!text-destructive",
                        "onclick": "document.getElementById('dialog-storage-disconnect-" ~ association.id ~ "').showModal()"
                      },
                    }
                  ]
                ) %}
                  {% include "deployment/partials/_options.html" with context %}
                {% endcall %}
              {% endif %}
            </div>

            {% if get_access(role, "admin") or association.storage.created_by_user_id == current_user.id %}
              {% call dialog(
                id="dialog-storage-environments-" ~ association.id,
                title=_('Edit environments', storage=association.storage.name),
                description=_('Select the environments that will have access to this storage.', project=project.name),
                dialog_attrs={"class": "max-w-lg"}
              ) %}
                {% include "project/partials/_dialog-project-storage-environments-form.html" with context %}
              {% endcall %}

              {% call dialog(
                id="dialog-storage-disconnect-" ~ association.id,
                title=_('Disconnect "%(project)s"?', project=project.name, storage=association.storage.name),
                dialog_attrs={"class": "max-w-md"}
              ) %}
                <div class="space-y-4" x-data="{ confirm: '' }">
                  <p>{{ _('This will disconnect the <b>"%(storage)s"</b> storage from the <b>"%(project)s"</b> project. Any new deployment for this project will no longer have access to this storage.', project=project.name, storage=association.storage.name) | safe }}</p>
                  <p>{{ _('To confirm, enter the project name <b>"%(project)s"</b> below.', project=project.name) | safe }}</p>
                  <form
                    method="post"
                    action="{{ rel_url_for('project_storage', team_slug=team.slug, project_name=project.name).include_query_params(fragment='disconnect_storage') }}"
                    hx-post="{{ rel_url_for('project_storage', team_slug=team.slug, project_name=project.name).include_query_params(fragment='disconnect_storage') }}"
                    hx-swap="outerHTML"
                    hx-indicator="find .htmx-indicator"
                    hx-disabled-elt="find button[type='submit']"
                    hx-on::before-request="document.activeElement && document.activeElement.blur()"
                    >
                    {{ remove_storage_form.csrf_token(id=False) }}
                    {{ remove_storage_form.association_id(id=False, value=association.id) }}
                    {{ remove_storage_form.confirm(
                      id=False,
                      class_='w-full input',
                      placeholder=_('Type the project name to confirm'),
                      **{
                        "x-model": "confirm",
                        "@keydown.enter": "confirm !== '"~project.name~"' ? $event.preventDefault() : null"
                      }
                    ) }}
                    <footer class="flex justify-end gap-x-2 pt-4">
                      <button type="button" class="btn-ghost" onclick="this.closest('dialog').close()">{{ _('Cancel') }}</button>
                      <button type="submit" class="btn-destructive group" :disabled="confirm !== '{{ project.name }}'">
                        {{ _('Disconnect') }}
                        <div class="htmx-indicator [&>svg]:size-4 [&>svg]:animate-spin">{% include "icons/loader.svg" %}</div>
                      </button>
                    </footer>
                  </form>
                </div>
              {% endcall %}
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </section>
  {% else %}
    <section class="flex items-center justify-center min-h-60 bg-card text-card-foreground border shadow-sm rounded-xl p-4">
      <div class="max-w-sm">
        <div class="text-center">
    <h2 class="h4">{{ _('No storage connected.') }}</h2>
    <p class="text-muted-foreground mt-1">{{ _('Connect new or existing storage to this project.') }}</p>
          <button
            type="button"
            class="btn-sm mt-4"
            onclick="document.getElementById('dialog-project-storage').showModal()"
          >
            {% include "icons/plus.svg" %}
            {{ _('Add storage') }}
          </button>
        </div>
      </div>
    </section>
  {% endif %}
</div>
{% endblock %}
