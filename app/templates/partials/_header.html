{% from "macros/dropdown-menu.html" import dropdown_menu %}
{% from "macros/avatar.html" import avatar with context %}
{% from "macros/dialog.html" import dialog %}
{% call dialog(
	title=_("New team"),
	description=_("Create a new team to manage your projects."),
	id="dialog-new-team",
	trigger_attrs={"role": "menuitem"},
	dialog_attrs={"class": "w-full max-w-xl"},
	body_attrs={"class": "space-y-4"}
) %}
	<div hx-get="{{ request.url_for('new_team') }}" hx-trigger="toggle from:closest dialog once"
		class="min-h-[114px] relative">
		<div class="htmx-indicator flex items-center justify-center inset-0 absolute bg-background/80">
			<div class="flex items-center gap-x-2 text-muted-foreground [&>svg]:size-4 [&>svg]:animate-spin">
				{% include "icons/loader.svg" %}
				{{ _('Saving') }}
			</div>
		</div>
	</div>
{% endcall %}
{% set trigger %}{% include "icons/chevrons-up-down.svg" %}{% endset %}
<header class="sticky top-0 bg-background z-20 border-b px-8 flex flex-col gap-y-2">
	<div class="flex items-center justify-between gap-x-4 h-16">
		<nav class="flex items-center gap-x-2.5">
			<a href="/" class="w-6 h-8 shrink-0 flex items-center justify-center" aria-label="{{ settings.app_name }}">
				<svg width="120" height="120" viewBox="0 0 120 120" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
					<path d="M39.9265 17L16.5652 103.791H0L23.3612 17H39.9265Z" />
					<path
						d="M81.7018 98.5804L71.6494 88.5988L92.6037 67.6445H47.1555V52.9198H92.6037L71.6494 31.9655L81.7018 21.9839L120 60.2822L81.7018 98.5804Z" />
				</svg>
			</a>

			{% if current_user %}
				{% if team %}
				<div class="text-muted-foreground/25 text-xl">/</div>
				<div class="flex items-center">
					<a href="{{ url_for('team_index', team_slug=team.slug) }}" class="btn-sm-ghost">
						{{ avatar(item=team, prefix="team", name=team.name, size="xs", class="-ml-1") }}
						{{ team.name }}
					</a>
					{% call dropdown_menu(
						trigger=trigger,
						trigger_attrs={"class": "btn-sm-ghost text-muted-foreground w-6"},
						popover_attrs={"data-align": "start"}
					) %}
					{% include "partials/_menu-teams.html" %}
					{% endcall %}
				</div>
				{% endif %}

				{% if project %}
				<div class="text-muted-foreground/25 text-xl">/</div>

				<div class="flex items-center">
					<a href="{{ url_for('project_index', team_slug=team.slug, project_name=project.name) }}" class="btn-sm-ghost">
						{% from "macros/avatar.html" import avatar with context %}
						{{ avatar(item=project, prefix="project", name=project.name, size="xs", class="-ml-1") }}
						{{ project.name }}
					</a>
					{% call dropdown_menu(
						trigger=trigger,
						trigger_attrs={"class": "btn-sm-ghost text-muted-foreground w-6"},
						popover_attrs={"data-align": "start"}
					) %}
						{% include "partials/_menu-projects.html" %}
					{% endcall %}
				</div>
				{% endif %}

				{% if deployment %}
					<div class="text-muted-foreground/25 text-xl">/</div>

					<div class="flex items-center">
						<a href="{{ url_for('project_deployment', team_slug=team.slug, project_name=project.name, deployment_id=deployment.id) }}"
							class="btn-sm-ghost">
							{% from "deployment/macros/status.html" import status %}
							{{ status(
							conclusion=deployment.conclusion,
							compact=True,
							attrs={ 'data-deployment-status': deployment.id }
							) }}
							<span class="font-mono">{{ deployment.id[:7] }}</span>
						</a>
						{% call dropdown_menu(
							trigger=trigger,
							trigger_attrs={"class": "btn-sm-ghost text-muted-foreground w-6"},
							popover_attrs={"data-align": "start"}
						) %}
							{% include "partials/_menu-deployments.html" %}
						{% endcall %}
					</div>
				{% endif %}
			{% endif %}
		</nav>

		<nav class="flex items-center gap-x-2" aria-label="User menu">
		  <div
				hx-get="{{ url_for('user_notifications') }}"
				hx-trigger="load"
				hx-swap="outerHTML"
			>
				<button type="button" class="btn-sm-icon-ghost rounded-full" disabled>
					{% include "icons/bell.svg" %}
				</button>
			</div>
			<button
				type="button"
				aria-label="Toggle dark mode"
				onclick="document.dispatchEvent(new CustomEvent('basecoat:theme'))"
				class="btn-sm-icon-ghost rounded-full"
			>
				<span class="hidden dark:block">{% include "icons/sun.svg" %}</span>
				<span class="block dark:hidden">{% include "icons/moon.svg" %}</span>
			</button>

			{% if current_user %}
				{% set trigger %}
					{% set fallback %}
						<img src="https://unavatar.io/{{ current_user.email }}?fallback=https://avatar.vercel.sh/{{ current_user.email }}?size=120" alt="{{ current_user.email }}" class="size-8 rounded-full shrink-0" />
					{% endset %}
					{{ avatar(item=current_user, prefix="user", name=current_user.name if current_user.name else current_user.username, class="!rounded-full", fallback=fallback) }}
				{% endset %}
				{% call dropdown_menu(
					trigger=trigger,
					trigger_attrs={'class': 'block'},
					popover_attrs={'data-align': 'end'}
				) %}
					<header class="px-2.5 py-1.5">
						<div class="font-medium">{{ current_user.name if current_user.name else current_user.username }}</div>
						<div class="text-muted-foreground">{{ current_user.email }}</div>
					</header>
					<hr role="separator" />
					<a href="{{ url_for('user_settings') }}" role="menuitem">{{ _('Account settings') }}</a>
					<hr role="separator" />
					<a href="{{ url_for('auth_logout') }}" role="menuitem">
						{{ _('Sign out') }}
					</a>
				{% endcall %}
			{% endif %}
		</nav>
	</div>

	{% if request.scope["route"].name.startswith("project_") %}
		{% include "partials/_tabs-project.html" %}
	{% endif %}
	{% if request.scope["route"].name.startswith("team_") %}
		{% include "partials/_tabs-team.html" %}
	{% endif %}
</header>