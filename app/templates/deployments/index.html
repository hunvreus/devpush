{% extends "base.html" %}

{% block app_content %}
<div class="container max-w-screen-lg mx-auto p-8 space-y-6">
  <header class="flex items-center gap-x-4 justify-between">
    <h1 class="h1 flex items-center gap-x-2.5">
      <a href="{{ url_for('main.project', project_name=project.name) }}">
        {% from "projects/components/thumbnail.html" import thumbnail %}
        {{ thumbnail(project) }}
      </a>
      <span class="text-muted-foreground/25 font-normal">/</span>
      <a href="{{ url_for('main.deployments', project_name=project.name) }}">
        {{ _('Deployments') }}
      </a>
      <span class="text-muted-foreground/25 font-normal">/</span>
      <span class="font-mono font-normal">{{ deployment.id[:7] }}</span>
    </h1>

    <div class="flex items-center gap-x-2 ml-auto">
      {% if deployment.conclusion %}
        <a
          href="{{ deployment.featured_url }}"
          class="btn-outline h-9 px-3 gap-x-2"
          target="_blank"
        >
          <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 17H7A5 5 0 0 1 7 7h2"/><path d="M15 7h2a5 5 0 1 1 0 10h-2"/><line x1="8" x2="16" y1="12" y2="12"/></svg>
          {{ _('Visit') }}
        </a>
      {% endif %}

      {% set trigger %}
        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
      {% endset %}
      {% from "components/dropdown.html" import dropdown %}
      {% call dropdown(trigger=trigger, trigger_class="btn-ghost w-9 h-9 px-0", menu_class="min-w-36" ) %}
        {% include "deployments/partials/_menu.html" %}
      {% endcall %}
    </div>
  </header>

  <ul class="flex gap-x-6 items-start text-muted-foreground" id="deployment-details">
    <li>
      <a
        class="flex items-center gap-x-1 hover:text-foreground transition-colors"
        href="https://github.com/{{ deployment.repo.full_name }}"
        target="_blank"
        data-tooltip="{{ _('Repository') }}"
      >
        <svg class="w-4 h-4 opacity-60 dark:opacity-70" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/><path d="M9 18c-4.51 2-5-2-7-2"/></svg>
        {{ deployment.repo.full_name }}
      </a>
    </li>
    <li>
      <a
        class="flex items-center gap-x-1 hover:text-foreground transition-colors"
        href="https://github.com/{{ deployment.repo.full_name }}/tree/{{ deployment.repo.branch }}"
        target="_blank"
        data-tooltip="{{ _('Branch') }}"
      >
        <svg class="w-4 h-4 opacity-60 dark:opacity-70" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="6" x2="6" y1="3" y2="15"/><circle cx="18" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><path d="M18 9a9 9 0 0 1-9 9"/></svg>
        {{ deployment.repo.branch }}
      </a>
    </li>
    <li>
      <a
        class="flex items-center gap-x-1 hover:text-foreground transition-colors"
        href="https://github.com/{{ deployment.repo.full_name }}/commit/{{ deployment.commit.sha }}"
        target="_blank"
        data-tooltip="{{ _('Commit (%(sha)s)', sha=deployment.commit.sha[:7]) }}"
      >
        <svg class="w-4 h-4 opacity-60 dark:opacity-70" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><line x1="3" x2="9" y1="12" y2="12"/><line x1="15" x2="21" y1="12" y2="12"/></svg>
        {{ deployment.commit.message }}
      </a>
    </li>
    <li class="flex items-center gap-x-1">
      <svg class="w-4 h-4 opacity-60 dark:opacity-70" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
      {{ deployment.environment }}
    </li>
  </ul>
  
  {% include 'deployments/partials/_info.html' %}

  <details open>
    <summary>{{ _('Build logs') }}</summary>
    <div
      class="overflow-y-auto h-[500px] relative"
      x-init="$el.scrollTop = $el.scrollHeight"
      {% if not deployment.conclusion %}
        hx-get=""
        hx-trigger="every 1s"
        hx-swap="innerHTML"
        hx-on::after-swap="this.scrollTop = this.scrollHeight"
      {% endif%}
      id="logs"
    >
      {% if not deployment.conclusion %}
        <div class="absolute inset-0 flex items-center justify-center text-muted-foreground">
          <div class="flex items-center gap-x-2">
            <svg class="h-4 w-4 animate-spin" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4"/><path d="m16.2 7.8 2.9-2.9"/><path d="M18 12h4"/><path d="m16.2 16.2 2.9 2.9"/><path d="M12 18v4"/><path d="m4.9 19.1 2.9-2.9"/><path d="M2 12h4"/><path d="m4.9 4.9 2.9 2.9"/></svg>
            {{ _('Waiting for logs...') }}
          </div>
        </div>
      {% endif %}
      {% include 'deployments/partials/_logs.html' %}
    </div>
  </details>
</div>

{% endblock %}