{% extends "setup/layouts/setup.html" %}

{% block title %}Setup: Confirm{% endblock %}

{% macro copy_button(id) %}
<button
  type="button"
  class="btn-sm-ghost-icon group [&_svg]:size-4 text-muted-foreground hover:text-foreground"
  onclick="
    const button = this;
    const el = document.getElementById('{{ id }}');
    if (!el) return;
    const text = el.textContent || '';
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(() => {
        button.dataset.copied = '';
        setTimeout(() => delete button.dataset.copied, 1000);
      });
    } else {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
      button.dataset.copied = '';
      setTimeout(() => delete button.dataset.copied, 1000);
    }
  "
>
  <span class="group-data-[copied]:hidden">{% include "icons/copy.svg" %}</span>
  <span class="hidden group-data-[copied]:block">{% include "icons/check.svg" %}</span>
</button>
{% endmacro %}

{% macro secret_field(id, value) %}
<div x-data="{ show: false }" class="flex-1 flex items-center gap-2 truncate">
  <div class="hidden" id="{{ id }}">{{ value }}</div>
  <div class="truncate mr-auto">
    <span x-show="!show">••••••••••••••••</span>
    <span x-show="show" class="truncate">{{ value }}</span>
  </div>
  <button type="button" @click="show = !show" class="btn-sm-ghost-icon text-muted-foreground hover:text-foreground [&_svg]:size-4">
    <span x-show="!show">{% include "icons/eye.svg" %}</span>
    <span x-show="show" x-cloak>{% include "icons/eye-off.svg" %}</span>
  </button>
  {{ copy_button(id) }}
</div>
{% endmacro %}

{% block setup_content %}
<div class="card w-full">
  <header class="border-b">
    <h2 class="h2">{{ _('Confirm configuration') }}</h2>
    <p>{{ _('Review and confirm your configuration before completing setup. This will restart services.') }}</p>
  </header>

  <section class="space-y-6">
    <div class="space-y-6">
      <section class="space-y-4">
        <h3 class="text-sm font-semibold">{{ _("Domains & SSL") }}</h3>
        <ul class="text-sm space-y-2">
          <li class="flex flex-col md:flex-row md:items-center gap-1">
            <div class="md:w-1/3 text-muted-foreground">{{ _("Application Hostname") }}</div>
            <div class="flex-1 flex items-center gap-2 truncate">
              <div class="truncate mr-auto" id="field-app-hostname">{{ setup_data.app_hostname }}</div>
              {{ copy_button('field-app-hostname') }}
            </div>
          </li>
          <li class="flex flex-col md:flex-row md:items-center gap-1">
            <div class="md:w-1/3 text-muted-foreground">{{ _("Deploy Domain") }}</div>
            <div class="flex-1 flex items-center gap-2 truncate">
              <div class="truncate mr-auto" id="field-deploy-domain">{{ setup_data.deploy_domain }}</div>
              {{ copy_button('field-deploy-domain') }}
            </div>
          </li>
          <li class="flex flex-col md:flex-row md:items-center gap-1">
            <div class="md:w-1/3 text-muted-foreground">{{ _("Let's Encrypt Email") }}</div>
            <div class="flex-1 flex items-center gap-2 truncate">
              {% if environment == "development" %}
                <div class="truncate mr-auto text-muted-foreground">{{ _("Disabled in development") }}</div>
              {% else %}
                <div class="truncate mr-auto" id="field-le-email">{{ setup_data.le_email }}</div>
                {{ copy_button('field-le-email') }}
              {% endif %}
            </div>
          </li>
          <li class="flex flex-col md:flex-row md:items-center gap-1">
            <div class="md:w-1/3 text-muted-foreground">{{ _("SSL Provider") }}</div>
            <div class="flex-1 flex items-center gap-2 truncate">
              {% if environment == "development" %}
                <div class="truncate mr-auto text-muted-foreground">{{ _("Disabled in development") }}</div>
              {% else %}
                <div class="truncate mr-auto" id="field-ssl-provider">{{ setup_data.ssl_provider }}</div>
                {{ copy_button('field-ssl-provider') }}
              {% endif %}
            </div>
          </li>
          {% if setup_data.ssl_provider == 'cloudflare' and setup_data.cloudflare_api_token %}
          <li class="flex flex-col md:flex-row md:items-center gap-1">
            <div class="md:w-1/3 text-muted-foreground">{{ _("Cloudflare API Token") }}</div>
            {{ secret_field('field-cloudflare-token', setup_data.cloudflare_api_token) }}
          </li>
          {% endif %}
          {% if setup_data.ssl_provider == 'route53' %}
            {% if setup_data.route53_access_key %}
            <li class="flex flex-col md:flex-row md:items-center gap-1">
              <div class="md:w-1/3 text-muted-foreground">{{ _("Route53 Access Key") }}</div>
              {{ secret_field('field-route53-access-key', setup_data.route53_access_key) }}
            </li>
            {% endif %}
            {% if setup_data.route53_secret_key %}
            <li class="flex flex-col md:flex-row md:items-center gap-1">
              <div class="md:w-1/3 text-muted-foreground">{{ _("Route53 Secret Key") }}</div>
              {{ secret_field('field-route53-secret-key', setup_data.route53_secret_key) }}
            </li>
            {% endif %}
          {% endif %}
          {% if setup_data.ssl_provider == 'digitalocean' and setup_data.digitalocean_token %}
          <li class="flex flex-col md:flex-row md:items-center gap-1">
            <div class="md:w-1/3 text-muted-foreground">{{ _("DigitalOcean Token") }}</div>
            {{ secret_field('field-digitalocean-token', setup_data.digitalocean_token) }}
          </li>
          {% endif %}
          {% if setup_data.ssl_provider == 'azure' %}
            {% if setup_data.azure_client_secret %}
            <li class="flex flex-col md:flex-row md:items-center gap-1">
              <div class="md:w-1/3 text-muted-foreground">{{ _("Azure Client Secret") }}</div>
              {{ secret_field('field-azure-client-secret', setup_data.azure_client_secret) }}
            </li>
            {% endif %}
          {% endif %}
          {% if setup_data.ssl_provider == 'gcloud' and setup_data.gcloud_service_account %}
          <li class="flex flex-col md:flex-row md:items-center gap-1">
            <div class="md:w-1/3 text-muted-foreground">{{ _("GCloud Service Account") }}</div>
            {{ secret_field('field-gcloud-service-account', setup_data.gcloud_service_account) }}
          </li>
          {% endif %}
        </ul>
      </section>
      
      <hr />

      <section class="space-y-4">
        <h3 class="text-sm font-semibold">{{ _("GitHub App") }}</h3>
        <ul class="text-sm space-y-2">
          <li class="flex flex-col md:flex-row md:items-center gap-1">
            <div class="md:w-1/3 text-muted-foreground">{{ _("App ID") }}</div>
            <div class="flex-1 flex items-center gap-2 truncate">
              <div class="truncate mr-auto" id="field-github-app-id">{{ setup_data.github_app_id }}</div>
              {{ copy_button('field-github-app-id') }}
            </div>
          </li>
          <li class="flex flex-col md:flex-row md:items-center gap-1">
            <div class="md:w-1/3 text-muted-foreground">{{ _("App Name") }}</div>
            <div class="flex-1 flex items-center gap-2 truncate">
              <div class="truncate mr-auto" id="field-github-app-name">{{ setup_data.github_app_name }}</div>
              {{ copy_button('field-github-app-name') }}
            </div>
          </li>
          <li class="flex flex-col md:flex-row md:items-center gap-1">
            <div class="md:w-1/3 text-muted-foreground">{{ _("Private Key") }}</div>
            {{ secret_field('field-github-private-key', setup_data.github_app_private_key) }}
          </li>
          <li class="flex flex-col md:flex-row md:items-center gap-1">
            <div class="md:w-1/3 text-muted-foreground">{{ _("Webhook Secret") }}</div>
            {{ secret_field('field-github-webhook-secret', setup_data.github_app_webhook_secret) }}
          </li>
          <li class="flex flex-col md:flex-row md:items-center gap-1">
            <div class="md:w-1/3 text-muted-foreground">{{ _("Client ID") }}</div>
            <div class="flex-1 flex items-center gap-2 truncate">
              <div class="truncate mr-auto" id="field-github-client-id">{{ setup_data.github_app_client_id }}</div>
              {{ copy_button('field-github-client-id') }}
            </div>
          </li>
          <li class="flex flex-col md:flex-row md:items-center gap-1">
            <div class="md:w-1/3 text-muted-foreground">{{ _("Client Secret") }}</div>
            {{ secret_field('field-github-client-secret', setup_data.github_app_client_secret) }}
          </li>
        </ul>
      </section>

      <hr />

      <section class="space-y-4">
        <h3 class="text-sm font-semibold">{{ _("Email") }}</h3>
        <ul class="text-sm space-y-2">
          <li class="flex flex-col md:flex-row md:items-center gap-1">
            <div class="md:w-1/3 text-muted-foreground">{{ _("Resend API Key") }}</div>
            {{ secret_field('field-resend-api-key', setup_data.resend_api_key) }}
          </li>
          <li class="flex flex-col md:flex-row md:items-center gap-1">
            <div class="md:w-1/3 text-muted-foreground">{{ _("Sender Address") }}</div>
            <div class="flex-1 flex items-center gap-2 truncate">
              <div class="truncate mr-auto" id="field-email-sender">{{ setup_data.email_sender_address }}</div>
              {{ copy_button('field-email-sender') }}
            </div>
          </li>
        </ul>
      </section>
    </div>

    <form method="post">
      <footer class="flex justify-between gap-x-2 -mx-6 px-6 pt-6 border-t">
        <a href="{{ url_for('setup_step_3') }}" class="btn-ghost">
          {% include "icons/arrow-left.svg" %}
          {{ _("Back") }}
        </a>
        <button type="submit" class="btn">
          {{ _("Complete setup") }}
        </button>
      </footer>
    </form>
  </section>
</div>
{% endblock %}
