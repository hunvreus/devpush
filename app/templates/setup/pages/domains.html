{% extends "setup/layouts/setup.html" %}

{% block title %}Setup: Domains & SSL{%
endblock %}

{% block setup_content %}
<div class="card w-full">
  <header class="border-b">
    <h2 class="h2">{{ _('Domains & SSL') }}</h2>
    <p>{{ _('Configure your domains for the main application and deployments, and the SSL certificate for the application.') }}</p>
  </header>

  <section>
    <form method="post" class="space-y-6">
      {{ form.csrf_token }}
      <div class="space-y-3" x-data="{ locked: true }">
        {{ form.server_ip.label(class="label") }}
        <div class="relative">
          {{ form.server_ip(
            class="input w-full font-mono text-[13px]",
            placeholder="192.168.1.1",
            **{
              ":readonly": "locked",
              ":class": "locked && 'text-muted-foreground'"
            }
          ) }}
          <button 
            type="button"
            class="absolute right-1.5 top-1/2 -translate-y-1/2 btn-icon-ghost text-muted-foreground hover:text-accent-foreground size-6"
            @click="locked = !locked"
          >
            <span x-show="!locked" class="[&>svg]:size-4" data-tooltip="{{ _("Lock") }}">
              {% include "icons/lock-open.svg" %}
            </span>
            <span x-show="locked" class="[&>svg]:size-4" data-tooltip="{{ _("Unlock") }}">
              {% include "icons/lock.svg" %}
            </span>
          </button>
        </div>
        <p class="text-muted-foreground text-sm [&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4 [&>code]:text-mono [&>code]:text-[13px]">{{ _("Your server's public IP address. This is used for DNS validation and GitHub App callbacks.") }}</p>
        {% for error in form.server_ip.errors %}
          <p class="text-destructive text-sm">{{ error }}</p>
        {% endfor %}
      </div>

      <div class="space-y-3">
        {{ form.app_hostname.label(class="label") }}
        <div class="relative">
          {{ form.app_hostname(
            class="input w-full pr-9",
            placeholder="deploy.example.com",
            **{
              ":required": "true",
              "aria-invalid": "true" if form.app_hostname.errors else "",
              "hx-post": url_for('setup_step_1').include_query_params(check_dns="app_hostname"),
              "hx-trigger": "input delay:500ms, blur, load",
              "hx-target": "next div + div",
              "hx-indicator": "next .htmx-indicator",
              "hx-include": "[name='server_ip']"
            }
          ) }}
          <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-muted-foreground [&>svg]:size-4 opacity-50 [&>svg]:animate-spin htmx-indicator peer">
            {% include "icons/loader.svg" %}
          </div>
          <div class="absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground [&>svg]:size-4 peer-[.htmx-request]:hidden"></div>
        </div>
        <p class="text-muted-foreground text-sm [&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4 [&>code]:text-mono [&>code]:text-[13px]">{{ _("Domain for the main application. Point your DNS records to the server IP above.") }}</p>
        {% for error in form.app_hostname.errors %}
          <p class="text-destructive text-sm">{{ error }}</p>
        {% endfor %}
      </div>

      <div class="space-y-3">
        {{ form.deploy_domain.label(class="label") }}
        <div class="relative">
          {{ form.deploy_domain(
            class="input w-full pr-9",
            placeholder="deploy.example.com",
            **{
              ":required": "true",
              "aria-invalid": "true" if form.deploy_domain.errors else "",
              "hx-post": url_for('setup_step_1').include_query_params(check_dns="deploy_domain"),
              "hx-trigger": "input delay:500ms, blur, load",
              "hx-target": "next div + div",
              "hx-indicator": "next .htmx-indicator",
              "hx-include": "[name='server_ip']"
            }
          ) }}
          <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-muted-foreground [&>svg]:size-4 opacity-50 [&>svg]:animate-spin htmx-indicator peer">
            {% include "icons/loader.svg" %}
          </div>
          <div class="absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground [&>svg]:size-4 peer-[.htmx-request]:hidden"></div>
        </div>
        <p class="text-muted-foreground text-sm">{{ _("Domain for deployments. Needs a wildcard DNS record pointing to the server IP above.") }}</p>
        {% for error in form.deploy_domain.errors %}
          <p class="text-destructive text-sm">{{ error }}</p>
        {% endfor %}
      </div>

      <div class="space-y-3">
        {{ form.le_email.label(class="label") }}
        {{ form.le_email(
          class="input w-full",
          placeholder="dev@example.com",
          **{
            ":required": "true",
            "aria-invalid": "true" if form.le_email.errors else ""
          }
        ) }}
        <p class="text-muted-foreground text-sm [&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4 [&>code]:text-mono [&>code]:text-[13px]">{{ _("Email for Let's Encrypt certificate notifications for renewal alerts.") }}</p>
        {% for error in form.le_email.errors %}
          <p class="text-destructive text-sm">{{ error }}</p>
        {% endfor %}
      </div>

      <fieldset x-data="{ sslProvider: '{{ form.ssl_provider.data or 'default' }}' }" class="flex flex-col gap-y-6">
        <div class="space-y-3">
          {{ form.ssl_provider.label(class="label") }}
          {{ form.ssl_provider(
            class="select w-full",
            **{
              "x-model": "sslProvider",
              "aria-invalid": "true" if form.ssl_provider.errors else ""
            }
          ) }}
          <p class="text-muted-foreground text-sm">{{ _("SSL provider for the application. We recommend using Cloudflare DNS.") }}</p>
          {% for error in form.ssl_provider.errors %}
            <p class="text-destructive text-sm">{{ error }}</p>
          {% endfor %}
        </div>

        <div x-show="sslProvider === 'cloudflare'" x-cloak class="space-y-3">
          {{ form.cloudflare_api_token.label(class="label") }}
          {{ form.cloudflare_api_token(
            class="input w-full font-mono text-[13px]",
            **{
              ":required": "sslProvider === 'cloudflare'",
              "aria-invalid": "true" if form.cloudflare_api_token.errors else ""
            }
          ) }}
          {% if form.cloudflare_api_token.description %}
            <p class="text-muted-foreground text-sm [&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4 [&>code]:text-mono [&>code]:text-[13px]">{{ form.cloudflare_api_token.description | safe }}</p>
          {% endif %}
          {% for error in form.cloudflare_api_token.errors %}
            <p class="text-destructive text-sm">{{ error }}</p>
          {% endfor %}
        </div>

        <div x-show="sslProvider === 'route53'" x-cloak class="space-y-6">
          <div class="space-y-3">
            {{ form.route53_access_key.label(class="label") }}
            {{ form.route53_access_key(
              class="input w-full font-mono text-[13px]",
              **{
                ":required": "sslProvider === 'route53'",
                "aria-invalid": "true" if form.route53_access_key.errors else ""
              }
            ) }}
            {% if form.route53_access_key.description %}
              <p class="text-muted-foreground text-sm [&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4 [&>code]:text-mono [&>code]:text-[13px]">{{ form.route53_access_key.description | safe }}</p>
            {% endif %}
            {% for error in form.route53_access_key.errors %}
              <p class="text-destructive text-sm">{{ error }}</p>
            {% endfor %}
          </div>
          <div class="space-y-3">
            {{ form.route53_secret_key.label(class="label") }}
            {{ form.route53_secret_key(
              class="input w-full font-mono text-[13px]",
              **{
                ":required": "sslProvider === 'route53'",
                "aria-invalid": "true" if form.route53_secret_key.errors else ""
              }
            ) }}
            {% for error in form.route53_secret_key.errors %}
              <p class="text-destructive text-sm">{{ error }}</p>
            {% endfor %}
          </div>
          <div class="space-y-3">
            {{ form.route53_region.label(class="label") }}
            {{ form.route53_region(
              class="input w-full font-mono text-[13px]",
              placeholder="us-east-1",
              **{
                ":required": "sslProvider === 'route53'",
                "aria-invalid": "true" if form.route53_region.errors else ""
              }
            ) }}
            {% if form.route53_region.description %}
              <p class="text-muted-foreground text-sm [&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4 [&>code]:text-mono [&>code]:text-[13px]">{{ form.route53_region.description | safe }}</p>
            {% endif %}
            {% for error in form.route53_region.errors %}
              <p class="text-destructive text-sm">{{ error }}</p>
            {% endfor %}
          </div>
        </div>

        <div x-show="sslProvider === 'gcloud'" x-cloak class="space-y-6">
          <div class="space-y-3">
            {{ form.gcloud_project.label(class="label") }}
            {{ form.gcloud_project(
              class="input w-full font-mono text-[13px]",
              **{
                ":required": "sslProvider === 'gcloud'",
                "aria-invalid": "true" if form.gcloud_project.errors else ""
              }
            ) }}
            {% if form.gcloud_project.description %}
              <p class="text-muted-foreground text-sm [&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4 [&>code]:text-mono [&>code]:text-[13px]">{{ form.gcloud_project.description | safe }}</p>
            {% endif %}
            {% for error in form.gcloud_project.errors %}
              <p class="text-destructive text-sm">{{ error }}</p>
            {% endfor %}
          </div>
          <div class="space-y-3">
            {{ form.gcloud_service_account.label(class="label") }}
            {{ form.gcloud_service_account(
              class="textarea w-full font-mono text-[13px]",
              rows="6",
              **{
                ":required": "sslProvider === 'gcloud'",
                "aria-invalid": "true" if form.gcloud_service_account.errors else ""
              }
            ) }}
            {% if form.gcloud_service_account.description %}
              <p class="text-muted-foreground text-sm [&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4 [&>code]:text-mono [&>code]:text-[13px]">{{ form.gcloud_service_account.description | safe }}</p>
            {% endif %}
            {% for error in form.gcloud_service_account.errors %}
              <p class="text-destructive text-sm">{{ error }}</p>
            {% endfor %}
          </div>
        </div>

        <div x-show="sslProvider === 'digitalocean'" x-cloak class="space-y-3">
          {{ form.digitalocean_token.label(class="label") }}
          {{ form.digitalocean_token(
            class="input w-full font-mono text-[13px]",
            **{
              ":required": "sslProvider === 'digitalocean'",
              "aria-invalid": "true" if form.digitalocean_token.errors else ""
            }
          ) }}
          {% if form.digitalocean_token.description %}
            <p class="text-muted-foreground text-sm [&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4 [&>code]:text-mono [&>code]:text-[13px]">{{ form.digitalocean_token.description | safe }}</p>
          {% endif %}
          {% for error in form.digitalocean_token.errors %}
            <p class="text-destructive text-sm">{{ error }}</p>
          {% endfor %}
        </div>

        <div x-show="sslProvider === 'azure'" x-cloak class="space-y-6">
          <div class="space-y-3">
            {{ form.azure_client_id.label(class="label") }}
            {{ form.azure_client_id(
              class="input w-full font-mono text-[13px]",
              **{
                ":required": "sslProvider === 'azure'",
                "aria-invalid": "true" if form.azure_client_id.errors else ""
              }
            ) }}
            {% if form.azure_client_id.description %}
              <p class="text-muted-foreground text-sm [&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4 [&>code]:text-mono [&>code]:text-[13px]">{{ form.azure_client_id.description | safe }}</p>
            {% endif %}
            {% for error in form.azure_client_id.errors %}
              <p class="text-destructive text-sm">{{ error }}</p>
            {% endfor %}
          </div>
          <div class="space-y-3">
            {{ form.azure_client_secret.label(class="label") }}
            {{ form.azure_client_secret(
              class="input w-full font-mono text-[13px]",
              **{
                ":required": "sslProvider === 'azure'",
                "aria-invalid": "true" if form.azure_client_secret.errors else ""
              }
            ) }}
            {% for error in form.azure_client_secret.errors %}
              <p class="text-destructive text-sm">{{ error }}</p>
            {% endfor %}
          </div>
          <div class="space-y-3">
            {{ form.azure_tenant_id.label(class="label") }}
            {{ form.azure_tenant_id(
              class="input w-full font-mono text-[13px]",
              **{
                ":required": "sslProvider === 'azure'",
                "aria-invalid": "true" if form.azure_tenant_id.errors else ""
              }
            ) }}
            {% if form.azure_tenant_id.description %}
              <p class="text-muted-foreground text-sm [&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4 [&>code]:text-mono [&>code]:text-[13px]">{{ form.azure_tenant_id.description | safe }}</p>
            {% endif %}
            {% for error in form.azure_tenant_id.errors %}
              <p class="text-destructive text-sm">{{ error }}</p>
            {% endfor %}
          </div>
          <div class="space-y-3">
            {{ form.azure_subscription_id.label(class="label") }}
            {{ form.azure_subscription_id(
              class="input w-full font-mono text-[13px]",
              **{
                ":required": "sslProvider === 'azure'",
                "aria-invalid": "true" if form.azure_subscription_id.errors else ""
              }
            ) }}
            {% if form.azure_subscription_id.description %}
              <p class="text-muted-foreground text-sm [&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4 [&>code]:text-mono [&>code]:text-[13px]">{{ form.azure_subscription_id.description | safe }}</p>
            {% endif %}
            {% for error in form.azure_subscription_id.errors %}
              <p class="text-destructive text-sm">{{ error }}</p>
            {% endfor %}
          </div>
          <div class="space-y-3">
            {{ form.azure_resource_group.label(class="label") }}
            {{ form.azure_resource_group(
              class="input w-full",
              **{
                ":required": "sslProvider === 'azure'",
                "aria-invalid": "true" if form.azure_resource_group.errors else ""
              }
            ) }}
            {% if form.azure_resource_group.description %}
              <p class="text-muted-foreground text-sm [&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4 [&>code]:text-mono [&>code]:text-[13px]">{{ form.azure_resource_group.description | safe }}</p>
            {% endif %}
            {% for error in form.azure_resource_group.errors %}
              <p class="text-destructive text-sm">{{ error }}</p>
            {% endfor %}
          </div>
        </div>
      </fieldset>

      <footer class="flex justify-between gap-x-2 -mx-6 px-6 pt-6 border-t">
        <button type="submit" class="ml-auto btn-sm">
          {{ _("Next") }}
          {% include "icons/arrow-right.svg" %}
        </button>
      </footer>
    </form>
  </section>
</div>
{% endblock %}