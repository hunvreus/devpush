{% macro dropdown(id=None, trigger=None, main_class=None, trigger_class=None, menu_class=None, menu_position=None) %}
<span
  x-data="{ 
    active: false,
    focusedIndex: -1,
    menuItems: [],
    init() {
      this.$nextTick(() => {
        this.menuItems = Array.from(this.$refs.menu.querySelectorAll('[role=menuitem]'));
      });
    },
    focusItem(index) {
      if (index >= 0 && index < this.menuItems.length) {
        this.focusedIndex = index;
        this.menuItems[index].focus();
      }
    },
    nextItem() {
      this.focusItem((this.focusedIndex + 1) % this.menuItems.length);
    },
    prevItem() {
      this.focusItem(this.focusedIndex <= 0 ? this.menuItems.length - 1 : this.focusedIndex - 1);
    }
  }"
  @click.away="active = false"
  class="dropdown {{ main_class }}"
  {% if id %}id="{{ id }}"{% endif %}
>
  {% if trigger %}
  <button
    @click="active = !active; $nextTick(() => { if(active && menuItems.length) focusItem(0); })"
    @keydown.down.prevent="active && nextItem()"
    aria-expanded="false"
    :aria-expanded="active"
    aria-haspopup="menu"
    aria-pressed="false"
    :aria-pressed="active"
    type="button"
    {% if id %}
    id="{{ id }}-trigger"
    aria-controls="{{ id }}-menu"
    {% endif %}
    {% if trigger_class %}class="{{ trigger_class }}"{% endif %}
  >
    {{ trigger }}
  </button>
  {% endif %}

  <nav
    x-ref="menu"
    @keydown.escape.window="active && (active = false)"
    @keydown.down.prevent="nextItem()"
    @keydown.up.prevent="prevItem()"
    @keydown.home.prevent="focusItem(0)"
    @keydown.end.prevent="focusItem(menuItems.length - 1)"
    x-cloak
    {% if id %}id="{{ id }}-menu"{% endif %}
    {% if menu_class %}class="{{ menu_class }}"{% endif %}
    role="menu"
    aria-orientation="vertical"
    aria-hidden="true"
    :aria-hidden="!active"
    {% if menu_position %}data-menu-position="{{ menu_position }}"{% endif %}
    @click="$event.target.closest('[role=menuitem]') && ($event.target.closest('[role=menuitem]').blur(), active = false)"
  >
    {{ caller() }}
  </nav>
</span>
{% endmacro %}