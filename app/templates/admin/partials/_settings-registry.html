{% from "macros/dialog.html" import dialog %}
{% from "macros/dropdown-menu.html" import dropdown_menu %}
{% from "macros/tabs.html" import tabs %}
{% from "macros/popover.html" import popover %}
{% from "macros/copy.html" import copy %}

{% if not registry_state.catalog %}
  <div class="card">
    <header class="border-b">
      <h2>{{ _('Registry') }}</h2>
      <p>{{ _('Manage runners and presets from the registry catalog.') }}</p>
    </header>
    <section>
      <p class="text-muted-foreground">{{ _('Registry catalog not found.') }}</p>
    </section>
  </div>
{% else %}
  <div class="card">
    <header class="border-b">
      <h2>{{ _('Registry') }}</h2>
      <p>{{ _('Manage runners and presets from the registry catalog.') }}</p>
    </header>

    <section class="space-y-6">
      <div id="registry-flash" class="hidden"></div>
      <ul class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <li>
          <div class="text-muted-foreground">{{ _('Catalog version') }}</div>
          <div class="flex items-center gap-x-2 h-5.5">
            <span class="font-mono text-[13px]">{{ registry_state.catalog.meta.version }}</span>
            <div
              hx-get="{{ url_for('admin_settings').include_query_params(fragment='registry-check') }}"
              hx-swap="outerHTML"
              hx-trigger="load"
              class="badge-secondary [&>svg]:animate-spin"
            >
              {{ _('Checking') }}
              {% include "icons/loader.svg" %}
            </div>
          </div>
        </li>
        <li>
          <div class="text-muted-foreground">{{ _('Catalog source') }}</div>
          <div class="h-5.5">{{ _('Bundled') if registry_state.catalog.meta.source == 'bundled' else _('Registry') }}</div>
        </li>
        <li>
          <div class="text-muted-foreground">{{ _('Overrides last updated') }}</div>
          <div class="h-5.5">
            {% if registry_overrides_updated_at %}
              {{ registry_overrides_updated_at | time_ago }}
            {% else %}
              <span class="text-muted-foreground">-</span>
            {% endif %}
          </div>          
        </li>
      </ul>

      {% set runners_panel %}
        <div class="space-y-4">
          <div class="rounded-xl border relative overflow-x-auto">
            <table class="table">
              <thead>
                <tr>
                  <th class="pl-4">{{ _('Enabled') }}</th>
                  <th>{{ _('Category') }}</th>
                  <th>{{ _('Name') }}</th>
                  <th>{{ _('Slug') }}</th>
                  <th class="w-40 text-right"></th>
                </tr>
              </thead>
              <tbody>
                {% for runner in registry_state.runners %}
                  <tr x-data="{ isEnabled: {{ 'true' if runner.enabled else 'false' }} }" class="h-12.5">
                    <td class="text-center pl-4">
                      <form
                        method="post"
                        action="{{ url_for('admin_settings').include_query_params(fragment='registry', action='registry-set-runner') }}"
                        hx-post="{{ url_for('admin_settings').include_query_params(fragment='registry', action='registry-set-runner') }}"
                        hx-trigger="change"
                        hx-target="#registry-flash"
                        hx-swap="innerHTML"
                        class="h-4.5 mx-auto"
                      >
                        {{ runner_set_form.csrf_token() }}
                        {{ runner_set_form.slug(value=runner.slug) }}
                        {{ runner_set_form.enabled(
                          class_="input",
                          role="switch",
                          checked=runner.enabled,
                          **{
                            'x-init': '',
                            '@change': 'isEnabled = event.target.checked'
                          }
                        ) }}
                      </form>
                    </td>
                    <td :class="{ 'opacity-50': !isEnabled }">
                      <div class="badge-secondary">{{ runner.category or '-' }}</div>
                    </td>
                    <td class="truncate w-full font-medium" :class="{ 'opacity-50': !isEnabled }">
                      {{ runner.name }}
                    </td>
                    <td class="font-mono text-muted-foreground" :class="{ 'opacity-50': !isEnabled }">{{ runner.slug }}</td>
                    <td class="text-right whitespace-nowrap">
                      <div class="flex items-center">
                        <form
                          method="post"
                          action="{{ url_for('admin_settings').include_query_params(fragment='registry', action='registry-pull') }}"
                          hx-post="{{ url_for('admin_settings').include_query_params(fragment='registry', action='registry-pull') }}"
                          hx-target="#registry-flash"
                          hx-confirm="{{ _('This will pull the image for this runner. Are you sure?') }}"
                          hx-swap="innerHTML"
                        >
                          {{ registry_image_form.csrf_token() }}
                          {{ registry_image_form.slug(value=runner.slug) }}
                          <button
                            type="submit"
                            role="menuitem"
                            class="btn-sm-icon-ghost"
                            aria-label="{{ _('Pull image') }}"
                            data-tooltip="{{ _('Pull image') }}"
                          >
                            {% include "icons/arrow-down.svg" %}
                          </button>
                        </form>
                        <form
                          method="post"
                          action="{{ url_for('admin_settings').include_query_params(fragment='registry', action='registry-clear') }}"
                          hx-post="{{ url_for('admin_settings').include_query_params(fragment='registry', action='registry-clear') }}"
                          hx-target="#registry-flash"
                          hx-confirm="{{ _('This will clear the image cache for this runner. Are you sure?') }}"
                          hx-swap="innerHTML"
                        >
                          {{ registry_image_form.csrf_token() }}
                          {{ registry_image_form.slug(value=runner.slug) }}
                          <button
                            type="submit"
                            role="menuitem"
                            class="btn-sm-icon-ghost"
                            aria-label="{{ _('Clear image cache') }}"
                            data-tooltip="{{ _('Clear image cache') }}"
                            data-align="end"
                          >
                            {% include "icons/x.svg" %}
                          </button>
                        </form>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
              <tfoot>
                <tr class="h-12.5">
                  <td colspan="4" class="pl-4">
                    <div class="flex items-center justify-between">
                      <div class="text-muted-foreground">{{ _('%(count)s runners', count=registry_state.runners | length) }}</div>
                    </div>
                  </td>
                  <td>
                    <div class="flex items-center">
                      <form
                        method="post"
                        action="{{ url_for('admin_settings').include_query_params(fragment='registry', action='registry-pull') }}"
                        hx-post="{{ url_for('admin_settings').include_query_params(fragment='registry', action='registry-pull') }}"
                        hx-target="#registry-flash"
                        hx-confirm="{{ _('This will pull all enabled images. Are you sure?') }}"
                        hx-swap="innerHTML"
                      >
                        {{ registry_image_form.csrf_token() }}
                        {{ registry_image_form.slug(value='') }}
                        <button
                          type="submit"
                          class="btn-sm-icon-ghost"
                          aria-label="{{ _('Pull all enabled') }}"
                          data-tooltip="{{ _('Pull all enabled') }}"
                          data-align="end"
                        >
                          {% include "icons/arrow-down.svg" %}
                        </button>
                      </form>
                      <form
                        method="post"
                        action="{{ url_for('admin_settings').include_query_params(fragment='registry', action='registry-clear') }}"
                        hx-post="{{ url_for('admin_settings').include_query_params(fragment='registry', action='registry-clear') }}"
                        hx-target="#registry-flash"
                        hx-confirm="{{ _('This will clear all cached images. Are you sure?') }}"
                        hx-swap="innerHTML"
                      >
                        {{ registry_image_form.csrf_token() }}
                        {{ registry_image_form.slug(value='') }}
                        <button
                          type="submit"
                          class="btn-sm-icon-ghost"
                          aria-label="{{ _('Clear all cached images') }}"
                          data-tooltip="{{ _('Clear all cached images') }}"
                          data-align="end"
                        >
                          {% include "icons/x.svg" %}
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      {% endset %}

      {% set presets_panel %}
        <div class="space-y-4">
          <div class="rounded-xl border relative overflow-x-auto">
            <table class="table">
              <thead>
                <tr>
                  <th class="pl-4">{{ _('Enabled') }}</th>
                  <th>{{ _('Category') }}</th>
                  <th>{{ _('Name') }}</th>
                  <th>{{ _('Slug') }}</th>
                  <th>{{ _('Runner') }}</th>
                </tr>
              </thead>
              <tbody>
                {% for preset in registry_state.presets %}
                  <tr x-data="{ isEnabled: {{ 'true' if preset.enabled else 'false' }} }" class="h-12.5">
                    <td class="text-center pl-4">
                      <form
                        method="post"
                        action="{{ url_for('admin_settings').include_query_params(fragment='registry', action='registry-set-preset') }}"
                        hx-post="{{ url_for('admin_settings').include_query_params(fragment='registry', action='registry-set-preset') }}"
                        hx-trigger="change"
                        hx-target="#registry-flash"
                        hx-swap="innerHTML"
                        class="h-4.5 mx-auto"
                      >
                        {{ preset_set_form.csrf_token() }}
                        {{ preset_set_form.slug(value=preset.slug) }}
                        {{ preset_set_form.enabled(
                          class_="input",
                          role="switch",
                          checked=preset.enabled,
                          **{
                            'x-init': '',
                            '@change': 'isEnabled = event.target.checked'
                          }
                        ) }}
                      </form>
                    </td>
                    <td :class="{ 'opacity-50': !isEnabled }">
                      <div class="badge-secondary">{{ preset.category or '-' }}</div>
                    </td>
                    <td class="truncate w-full font-medium" :class="{ 'opacity-50': !isEnabled }">
                      {{ preset.name }}
                    </td>
                    <td class="font-mono text-muted-foreground" :class="{ 'opacity-50': !isEnabled }">{{ preset.slug }}</td>
                    <td class="font-mono text-muted-foreground" :class="{ 'opacity-50': !isEnabled }">{{ preset.config.runner }}</td>
                  </tr>
                {% endfor %}
              </tbody>
              <tfoot>
                <tr class="h-12.5">
                  <td colspan="5" class="pl-4">
                    <div class="flex items-center justify-between">
                      <div class="text-muted-foreground">{{ _('%(count)s presets', count=registry_state.presets | length) }}</div>
                    </div>
                  </td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      {% endset %}

      {{ tabs(
        tabsets=[
          {
            "id": "registry-runners",
            "tab": _("Runners"),
            "panel": runners_panel,
            "panel_attrs": {"class": "pt-4"}
          },
          {
            "id": "registry-presets",
            "tab": _("Presets"),
            "panel": presets_panel,
            "panel_attrs": {"class": "pt-4"}
          }
        ],
        main_attrs={"class": "w-full"},
        tablist_attrs={"class": "w-full"},
      ) }}
    </section>

    <div class="htmx-indicator flex items-center justify-center inset-0 absolute bg-background/80 rounded-xl">
      <div class="flex items-center gap-x-2 text-muted-foreground [&>svg]:size-4 [&>svg]:animate-spin">
        {% include "icons/loader.svg" %}
        {{ _('Updating') }}
      </div>
    </div>
  </div>
{% endif %}
