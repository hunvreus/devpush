---
- hosts: all
  vars:
    deploy_user: deploy
    app_dir: /home/deploy/devpush
    github_repo: "{{ github_repo }}"

  tasks:
    - name: Test GitHub SSH connection
      command: ssh -T git@github.com
      register: github_test
      failed_when: github_test.rc != 1
      changed_when: false

    - name: Display GitHub connection status
      debug:
        msg: "âœ… GitHub SSH connection successful"
      when: github_test.rc == 1

    - name: Clone repository
      git:
        repo: "{{ github_repo }}"
        dest: "{{ app_dir }}"
        update: yes
        force: yes

    - name: Copy .env file for app container
      ansible.builtin.copy:
        src: ../../.env.app
        dest: "{{ app_dir }}/.env"
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: "0600"

    - name: Pull Docker images
      command: docker compose pull
      args:
        chdir: "{{ app_dir }}"

    - name: Start services
      command: docker compose up -d --remove-orphans
      args:
        chdir: "{{ app_dir }}"



    # - name: Start services and debug on failure
    #   block:
    #     - name: Start services (with 2-minute timeout)
    #       command: docker compose up -d --remove-orphans
    #       args:
    #         chdir: "{{ app_dir }}"
    #       async: 120
    #       poll: 5

    #   rescue:
    #     - name: "FAILURE: Get container status"
    #       command: docker compose ps
    #       args:
    #         chdir: "{{ app_dir }}"
    #       register: ps_output
    #       changed_when: false
    #       failed_when: false

    #     - name: "FAILURE: Display container status"
    #       debug:
    #         var: ps_output.stdout_lines

    #     - name: "FAILURE: Get container logs"
    #       command: docker compose logs --tail="50"
    #       args:
    #         chdir: "{{ app_dir }}"
    #       register: logs_output
    #       changed_when: false
    #       failed_when: false

    #     - name: "FAILURE: Display container logs"
    #       debug:
    #         var: logs_output.stdout_lines

    #     - fail:
    #         msg: "Docker Compose failed to start. See logs above."