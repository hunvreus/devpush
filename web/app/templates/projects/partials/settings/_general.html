{% if not is_fragment %}
{% from "components/dialog.html" import dialog %}
{% call dialog(
  id="dialog-repo-select",
  title="Select repository",
  dialog_attrs={
    "class": "max-w-screen-sm w-full",
    "@repo-selected": "$el.close()",
    "x-init": ""
  }
) %}
  <div
    hx-get="{{ url_for('main.repo_select', account=repo_owner) }}"
    hx-trigger="dialog:opened from:closest dialog once"
    class="flex items-start justify-center h-[296px]"
  >
    <div class="space-y-4 w-full">
      <div class="flex items-center gap-x-2">
        <div class="bg-accent animate-pulse h-9 max-w-1/3 rounded-md flex-1"></div>
        <div class="bg-accent animate-pulse h-9 rounded-md flex-1"></div>
      </div>
      <div class="animate-pulse h-60 rounded-lg border">
        <ul>
          {% for i in range(5) %}
          <li class="flex gap-x-2 items-center justify-between border border-b-0 last:border-b first:rounded-t-lg last:rounded-b-lg px-4 h-12 text-sm hover:bg-muted/50 transition-colors">
            <div class="bg-accent animate-pulse h-4 max-w-1/3 flex-1 rounded w-96"></div>
            <button type="button" class="btn-sm" disabled>
              {{ _('Select') }}
            </button>
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
{% endcall %}
{% endif %}

<form
  method="POST"
  enctype="multipart/form-data"
  action="{{ url_for('main.project_settings', project_name=project.name, fragment='general') }}"
  hx-post="{{ url_for('main.project_settings', project_name=project.name, fragment='general') }}"
  hx-indicator="next .htmx-indicator"
  hx-swap="outerHTML"
  x-data="{
    changed: false,
    repoId: {{ project.repo_id }},
    repoOwner: '{{ project.repo_full_name.split('/')[0] }}',
    repoFullName: '{{ project.repo_full_name }}',
    deleteAvatar: false
  }"
  @repo-selected.window="
    repoId = $event.detail.id;
    repoOwner = $event.detail.owner;
    repoFullName = $event.detail.fullName;
    changed = true;
  "
  @input="changed = true"
  @change="changed = true"
  class="card"
>
  {{ general_form.hidden_tag() }}
  <header class="border-b">
    <h2>{{ _('General') }}</h2>
    <p>{{ _('General settings for the project including the Git repository.') }}</p>
  </header>
  
  <section class="space-y-6">
    <div class="space-y-3">
      {{ general_form.name.label() }}
      {{ general_form.name(class="input w-full") }}
      {% for error in general_form.name.errors %}
        <p class="text-destructive text-sm">{{ error }}</p>
      {% endfor %}
    </div>
  
    <div class="space-y-3">
      <label for="name">{{ _('Avatar') }}</label>
      {% from "components/image_upload.html" import image_upload %}
      {% from "projects/components/thumbnail.html" import thumbnail %}
      {% set current_image %}
        {{ thumbnail(project, size="md") }}
      {% endset %}
      {% set default_image %}
        {{ thumbnail(project, size="md", ignore_avatar=True) }}
      {% endset %}
      {{ image_upload(
        general_form.avatar,
        general_form.delete_avatar,
        current_image,
        default_image,
        extensions=["jpg", "jpeg", "png", "gif", "webp"]
      ) }}
    </div>
  
    <div class="space-y-3">
      <label for="name">{{ _('Git repository') }}</label>
      {{ general_form.repo_id(
        class_="hidden",
        **{':value': 'repoId'}
      ) }}
      <div class="flex items-center gap-x-2">
        <button
          type="button"
          class="btn-outline font-normal px-3 flex items-center gap-x-2"
          onclick="
            const dialog = document.getElementById('dialog-repo-select');
            dialog.dispatchEvent(new Event('dialog:opened'));
            dialog.showModal();
          "
        >
          <img :src="`https://github.com/${repoOwner}.png`" :alt="`${repoOwner}'s avatar`" class="w-6 h-6 rounded">
          <span x-text="repoFullName"></span>
          <span class="text-muted-foreground">
            {% include "shared/icons/chevrons-up-down.svg" %}
          </span>
        </button>
      </div>
      {% for error in general_form.repo_id.errors %}
        <p class="text-destructive text-sm">{{ error }}</p>
      {% endfor %}
    </div>
  </section>

  <footer>
    <button class="btn" :disabled="!changed">{{ _('Save') }}</button>
  </footer>
</form>

<div class="htmx-indicator flex items-center justify-center inset-0 absolute bg-background/80 rounded-xl">
  <div class="flex items-center gap-x-2 text-muted-foreground [&>svg]:size-4 [&>svg]:animate-spin">
    {% include "shared/icons/loader.svg" %}
    {{ _('Saving') }}
  </div>
</div>