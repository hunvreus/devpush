services:
  app:
    labels:
      - traefik.http.routers.app.entrypoints=websecure
      - traefik.http.routers.app.tls=true
      - traefik.http.routers.app.tls.certresolver=le
      - traefik.http.routers.app.priority=10
    volumes:
      - /srv/devpush/traefik:/data/traefik
      - /srv/devpush/upload:/app/upload
      - /srv/devpush/access.json:/app/settings/access.json

  worker-arq:
    volumes:
      - /srv/devpush/traefik:/data/traefik

  pgsql:
    ports:
      - "127.0.0.1:5432:5432"
    networks:
      - default

  traefik:
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /srv/devpush/traefik:/etc/traefik/dynamic_conf
    labels:
      - "traefik.http.routers.deployment-not-found-https.rule=HostRegexp(`^(.+)\\.${DEPLOY_DOMAIN}$`)"
      - "traefik.http.routers.deployment-not-found-https.entrypoints=websecure"
      - "traefik.http.routers.deployment-not-found-https.tls=true"
      - "traefik.http.routers.deployment-not-found-https.tls.certresolver=le"
      - "traefik.http.routers.deployment-not-found-https.priority=1"
      - "traefik.http.routers.deployment-not-found-https.service=noop@internal"
      - "traefik.http.routers.deployment-not-found-https.middlewares=deployment-redirect"